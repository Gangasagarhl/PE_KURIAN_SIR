<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebRTC Call from Server</title>
  </head>
  <body>
    <h1>WebRTC Call from Server</h1>
    <!-- This video element will display the media stream coming from the server -->
    <video id="remoteVideo" autoplay playsinline style="width:640px; height:480px;"></video>
    <script>
      (async function() {
        // Create a new RTCPeerConnection.
        const pc = new RTCPeerConnection();

        // When a remote stream is received, display it.
        const remoteVideo = document.getElementById("remoteVideo");
        pc.ontrack = function(event) {
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            console.log("Received remote stream");
          }
        };

        // (Optional) Get the client's local media and add tracks.
        // This allows two-way communication if desired.
        try {
          const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        } catch (err) {
          console.error("Error accessing local media:", err);
        }

        // Create an SDP offer.
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // Send the offer to the server.
        const response = await fetch("/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type
          })
        });

        // Parse the JSON answer from the server.
        const answer = await response.json();
        await pc.setRemoteDescription(answer);
        console.log("Call established");
      })();
    </script>
  </body>
</html>
